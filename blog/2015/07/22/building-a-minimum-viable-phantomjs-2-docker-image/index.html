<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Building a minimum viable PhantomJS 2 Docker image | Fabio Rehm&#39;s Blog</title>

<meta property='og:title' content='Building a minimum viable PhantomJS 2 Docker image - Fabio Rehm&#39;s Blog'>
<meta property='og:description' content='How did I build and release the smallest PhantomJS image you&#39;ll see on the Docker Hub'>
<meta property='og:url' content='http://fabiorehm.com/blog/2015/07/22/building-a-minimum-viable-phantomjs-2-docker-image/'>
<meta property='og:site_name' content='Fabio Rehm&#39;s Blog'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/a198addd98dd9f149c7964a1340c9772?s=256'><meta property='article:section' content='Blog'><meta property='article:tag' content='docker'><meta property='article:tag' content='dockerize'><meta property='article:tag' content='phantomjs'><meta property='article:published_time' content='2015-07-22T00:00:00Z'/><meta property='article:modified_time' content='2015-07-22T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@fgrehm'><meta name='twitter:creator' content='@fgrehm'>
<link rel="stylesheet" href="http://fabiorehm.com/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://fabiorehm.com"><h1 class="title is-4">Fabio Rehm&#39;s Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:fgrehm@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/fabiorehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/docker">#docker</a>



  
  | <a class="subtitle is-6" href="/tags/dockerize">#dockerize</a>
  
  | <a class="subtitle is-6" href="/tags/phantomjs">#phantomjs</a>
  

      
    </div>
    <h2 class="subtitle is-6">July 22, 2015</h2>
    <h1 class="title">Building a minimum viable PhantomJS 2 Docker image</h1>
      
    <div class="content">
      

<p>As part of something I&rsquo;ve been hacking on the side, I have a need to run a bunch of
<a href="http://phantomjs.org/" target="_blank">PhantomJS</a> 2.0 containers on a Docker host. While I could&rsquo;ve just
built an image that includes its binary and consider it done, there is currently <a href="https://github.com/ariya/phantomjs/issues/12948" target="_blank">a need
to build the phantomjs binary from sources for Linux machines</a>.
Not only that is a PITA but it also requires us to do some &ldquo;juggling&rdquo; to clean up build-time
dependencies and it still produces a somewhat large Docker image as a result (something in
the ~400mb).</p>

<p>After some initial research I could find <a href="https://registry.hub.docker.com/u/rosenhouse/phantomjs2/" target="_blank">a Docker image</a>
that does that <a href="https://github.com/rosenhouse/phantomjs2/blob/1df72b25bc231693c3d059d71ec40cd6e27d6872/Dockerfile#L12-L38" target="_blank">heavy lifting</a>
but I still wanted a smaller image as I have been bitten by the &ldquo;minimalist docker images&rdquo; bug
after coming across <a href="http://blog.oddbit.com/2015/02/05/creating-minimal-docker-images/" target="_blank">this blog post</a>
and also getting to know <a href="http://alpinelinux.org/" target="_blank">Alpine Linux</a>.</p>

<h2 id="compiling-from-sources-under-gliderlabs-alpine-failed">Compiling from sources under <code>gliderlabs/alpine</code> (failed)</h2>

<p>My first attempt was to use the <a href="http://gliderlabs.viewdocs.io/docker-alpine/about" target="_blank">gliderlabs/alpine</a>
image and build phantomjs from sources but unfortunately that didn&rsquo;t work. I&rsquo;m not sure
what is the actual root cause for that but I had lots of weird compilation errors. I risk
saying it is because of <a href="http://gliderlabs.viewdocs.io/docker-alpine/about#user-content-musl-libc" target="_blank">musl libc</a>
or the compiler available to Alpine Linux but I haven&rsquo;t had a chance to dig into it yet.
I even tried using Alpine&rsquo;s prebuilt QtWebKit packages (required by PhantomJS) but had no
luck as well.</p>

<h2 id="using-dockerize-https-github-com-larsks-dockerize-to-produce-a-minimalist-image">Using <a href="https://github.com/larsks/dockerize" target="_blank">dockerize</a> to produce a minimalist image</h2>

<p>After failing at compiling PhantomJS from sources, I decided to take a stab on using
<a href="https://github.com/larsks/dockerize" target="_blank">dockerize</a> to produce the bare minimum required
to run the phantomjs CLI.</p>

<p><code>dockerize</code> is a pretty cool tool for creating minimal Docker images from dynamically linked
<a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format" target="_blank">ELF binaries</a>. Its CLI has
many <a href="https://github.com/larsks/dockerize#synopsis" target="_blank">different options</a> and the idea is that
you can run a simple <code>dockerize -t sed /bin/sed</code> and get a minimal image with everything
that is needed for <code>sed</code> to run <a href="http://docs.docker.com/articles/baseimages/#creating-a-simple-base-image-using-scratch" target="_blank">using <code>scratch</code> as the starting point</a>.</p>

<p>In order to make things simpler, I created <a href="https://github.com/fgrehm/docker-phantomjs2/blob/master/Dockerfile.dockerize" target="_blank">an environment</a>
based off of <a href="https://registry.hub.docker.com/u/rosenhouse/phantomjs2/" target="_blank">rosenhouse/phantomjs2</a>
with <code>dockerize</code> in place and started hacking away on top of it. After lots of experiments,
this is what I put together to produce the sources for a minimalist PhantomJS image:</p>

<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># For the most up to date version of this, please check the link below:
</span><span class="c1">#   https://github.com/fgrehm/docker-phantomjs2/blob/master/dockerize-phantomjs
</span><span class="c1"></span>dockerize -n -o dockerized-phantomjs <span class="se">\
</span><span class="se"></span>          -e <span class="k">$(</span>which phantomjs<span class="k">)</span> <span class="se">\
</span><span class="se"></span>          -a /bin/dash /bin/sh <span class="se">\
</span><span class="se"></span>          -a /etc/fonts /etc  <span class="se">\
</span><span class="se"></span>          -a /etc/ssl /etc  <span class="se">\
</span><span class="se"></span>          --verbose <span class="se">\
</span><span class="se"></span>          <span class="k">$(</span>which phantomjs<span class="k">)</span> <span class="se">\
</span><span class="se"></span>          /usr/bin/curl</code></pre></div>

<p>Can&rsquo;t get any easier than that right?</p>

<p>But that actually took me a while to get it right. As you might imagine, things did not work
on my first interactions with <code>dockerize</code>. The tool itself works perfectly, but for reasons
that I haven&rsquo;t figured out yet the <code>phantomjs</code> CLI did not work properly on my new image
unless I also vendor <code>curl</code> related dependencies. Another thing that gave me trouble was
the fact that system fonts were not being included on the new image and screenshots produced
by <code>phantomjs</code> for some apps would come out with blank text blocks because of that.</p>

<p>My advice in case you decide to try out <code>dockerize</code> with some other executable is
to provision a container with the executable within a <code>docker run</code> and <code>docker diff CONTAINER_ID</code>
afterwards, looking for potential &ldquo;suspects&rdquo; that might be missing on your minimal
image.</p>

<h2 id="publishing-the-image-on-docker-hub">Publishing the image on Docker Hub</h2>

<p>With everything running smooth locally, the next step was to set up an <a href="http://docs.docker.com/docker-hub/builds/" target="_blank">Automated Build</a>
and get the image on the <a href="http://hub.docker.com/" target="_blank">hub</a>. There is just a small gotcha around
that: AFAIK there is no way we can docker inside <code>docker build</code> as it <a href="https://github.com/docker/docker/issues/1916" target="_blank">does not support the <code>--privileged</code> flag</a>
that is <a href="https://github.com/jpetazzo/dind#quickstart" target="_blank">required to run nested docker instances</a>.</p>

<p>To work aroud that, I created a <a href="https://github.com/fgrehm/docker-phantomjs2/releases" target="_blank">GitHub release</a>
on the project with a tarball of all dependencies that can be extracted under <code>/</code>.</p>

<p>Based on the <a href="https://github.com/fgrehm/docker-phantomjs2/blob/master/Dockerfile.localbuild#L3" target="_blank"><code>Dockerfile</code> I used to build the image locally</a>,
my initial <code>Dockerfile</code> looked like this:</p>

<div class="highlight"><pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">ADD</span><span class="s"> https://github.com/fgrehm/docker-phantomjs2/releases/download/v2.0.0-20150722/dockerized-phantomjs.tar.gz /</span><span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span><span class="s"> [&#34;/usr/local/bin/phantomjs&#34;]</span></code></pre></div>

<p>But that did not work and the reason can be found in the <a href="http://docs.docker.com/reference/builder/#add" target="_blank"><code>ADD</code> instruction</a>
docs:</p>

<blockquote>
<p>If <code>&lt;src&gt;</code> is a local tar archive in a recognized compression format (identity, gzip, bzip2 or xz) then it is unpacked as a directory. Resources from remote URLs are not decompressed. When a directory is copied or unpacked, it has the same behavior as <code>tar -x</code>, the result is the union of:</p>

<ol>
<li>Whatever existed at the destination path and</li>
<li>The contents of the source tree, with conflicts resolved in favor of “2.” on a file-by-file basis.</li>
</ol>
</blockquote>

<p>I got tricked by the fact that local files <code>ADD</code>ed to an image are automagically extracted but
remote <code>ADD</code>ed files are not. Since the <code>scratch</code> image has an empty filesystem, my solution
to this was to keep things simple again and just switch to an Alpine Linux base image that
includes <code>tar</code> and <code>curl</code> so I can download the tarball from GitHub and extract it on top of
the image&rsquo;s <code>/</code> without relying on the <code>ADD</code> behavior:</p>

<div class="highlight"><pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> gliderlabs/alpine:3.2</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apk-install curl <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -Ls https://github.com/fgrehm/docker-phantomjs2/releases/download/v2.0.0-20150722/dockerized-phantomjs.tar.gz <span class="se">\
</span><span class="se"></span>       <span class="p">|</span> tar xz -C /<span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span><span class="s"> [&#34;/usr/local/bin/phantomjs&#34;]</span></code></pre></div>

<p>That&rsquo;s mostly because the phantomjs tarball has ~50Mb and I didn&rsquo;t want to include it on
source control, but if your executable is small, I&rsquo;d recommend keeping it around and
sticking to the <code>FROM scratch</code> + <code>ADD tarball.tgz /</code> combo when possible.</p>

<h2 id="that-s-it">That&rsquo;s it</h2>

<p>The image is already available on the Docker Hub as <code>fgrehm/phantomjs2</code> so feel free to
give it a try.</p>

<p>Some of you might question the security out of using my image as it involves extracting a
remote tarball on top of <code>/</code>. If you are one of those feel free to build the image yourself,
its as easy as a <code>git clone</code> and a <code>make build.local</code>. If you want to go hardcore and / or
have the time to spend building phantomjs from sources, you can <code>make phantomjs.build build.local</code> :)</p>

<p>So far things have been working fine for the examples provided by the <a href="https://github.com/ariya/phantomjs/tree/master/examples" target="_blank">phantomjs project itself</a>
and some other hacks I put together, but please <a href="https://github.com/fgrehm/docker-phantomjs2/issues/new" target="_blank">let me know</a>
in case you have any trouble!</p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'fgrehm';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/fgrehm">Fabio Rehm</a> 2017</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-37437857-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>
