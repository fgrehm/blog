<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Crafting your own vagrant-lxc base box | Fabio Rehm&#39;s Blog</title>

<meta property='og:title' content='Crafting your own vagrant-lxc base box - Fabio Rehm&#39;s Blog'>
<meta property='og:description' content='How to build your own vagrant-lxc base boxes'>
<meta property='og:url' content='http://fabiorehm.com/blog/2013/07/18/crafting-your-own-vagrant-lxc-base-box/'>
<meta property='og:site_name' content='Fabio Rehm&#39;s Blog'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/a198addd98dd9f149c7964a1340c9772?s=256'><meta property='article:section' content='Blog'><meta property='article:tag' content='vagrant'><meta property='article:tag' content='vagrant-lxc'><meta property='article:tag' content='lxc'><meta property='article:tag' content='linux containers'><meta property='article:published_time' content='2013-07-18T00:00:00Z'/><meta property='article:modified_time' content='2013-07-18T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@fgrehm'><meta name='twitter:creator' content='@fgrehm'>
<link rel="stylesheet" href="http://fabiorehm.com/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://fabiorehm.com"><h1 class="title is-4">Fabio Rehm&#39;s Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:fgrehm@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/fabiorehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/vagrant">#vagrant</a>



  
  | <a class="subtitle is-6" href="/tags/vagrant-lxc">#vagrant-lxc</a>
  
  | <a class="subtitle is-6" href="/tags/lxc">#lxc</a>
  
  | <a class="subtitle is-6" href="/tags/linux-containers">#linux containers</a>
  

      
    </div>
    <h2 class="subtitle is-6">July 18, 2013</h2>
    <h1 class="title">Crafting your own vagrant-lxc base box</h1>
      
    <div class="content">
      

<p>As I <a href="/blog/2013/06/10/improving-vagrant-lxc-boxes/">said before</a>, &ldquo;next generation&rdquo;
<a href="https://github.com/fgrehm/vagrant-lxc" target="_blank">vagrant-lxc</a> boxes should simplify the process
of &ldquo;promoting&rdquo; existing containers to base boxes. To back that up I&rsquo;ve wrote
a detailed step-by-step for creating an Ubuntu Precise and Debian Squeeze base boxes
from an Ubuntu Host and I&rsquo;m pretty sure it is possible to reuse the ideas from this
post to build base boxes for / from other distros that suits everyone&rsquo;s needs.</p>

<p>I&rsquo;ve followed the steps on an Ubuntu 12.10 VirtualBox VM and if you want to follow
along you might want to grab yourself a copy of the same <a href="https://gist.github.com/fgrehm/b07c6370a710be622807#file-ubuntu-host-rb" target="_blank">Vagrantfile</a>
I used and fire it up with <code>vagrant up --provider=virtualbox</code>. I&rsquo;m also assuming
that you&rsquo;ll follow each step within the same shell session as we&rsquo;ll be reusing
some variables between steps.</p>

<p><em>If you want a &ldquo;copy &amp; paste version&rdquo; of this post check this <a href="https://gist.github.com/fgrehm/6034400" target="_blank">gist</a>
out</em></p>

<h2 id="bootstrapping-the-guest-container-rootfs">Bootstrapping the guest container rootfs</h2>

<p>The first thing we&rsquo;ll do is create the base container with <code>lxc-create</code> with
<a href="https://github.com/lxc/lxc/tree/staging/templates" target="_blank">vanilla templates</a>, for
Ubuntu guests that means:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">RELEASE</span><span class="o">=</span>precise
<span class="nv">ARCH</span><span class="o">=</span>amd64
sudo lxc-create -n <span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-base -t ubuntu -- --release <span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span> --arch <span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span></code></pre></div>

<p>And for Debian guests:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SUITE</span><span class="o">=</span>squeeze
<span class="nv">RELEASE</span><span class="o">=</span><span class="nv">$SUITE</span>
sudo lxc-create -n <span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-base -t debian</code></pre></div>

<p><em>Before you ask, I decided to set both a <code>SUITE</code> and a <code>RELEASE</code> variables because
the debian template <a href="https://github.com/lxc/lxc/blob/staging/templates/lxc-debian.in#L23" target="_blank">expects</a>
a <code>SUITE</code> env var to specify the release version and we&rsquo;ll be referencing it
by just <code>$RELEASE</code> on the rest of the post to make things easier :)</em></p>

<p>If you want to know more about the parameters a template accepts, try running
<code>lxc-create -t &lt;template-name&gt; -- --help</code> or look into the scripts at <code>/usr/share/lxc/templates</code>.</p>

<p>To finish up this initial setup, some aditional steps are required to make sure
the Debian containers will get to play well with Vagrant / vagrant-lxc:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">rootfs</span><span class="o">=</span><span class="s2">&#34;/var/lib/lxc/</span><span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span><span class="s2">-base/rootfs&#34;</span>

<span class="c1"># This fixes some networking issues
</span><span class="c1"># See https://github.com/fgrehm/vagrant-lxc/issues/91 for more info
</span><span class="c1"></span>sudo sed -i -e <span class="s2">&#34;s/\(127.0.0.1\s\+localhost\)/\1\n127.0.1.1\t</span><span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span><span class="s2">-base\n/g&#34;</span> <span class="si">${</span><span class="nv">rootfs</span><span class="si">}</span>/etc/hosts

<span class="c1"># This ensures that `/tmp` does not get cleared on halt
</span><span class="c1"># See https://github.com/fgrehm/vagrant-lxc/issues/68 for more info
</span><span class="c1"></span>sudo chroot <span class="nv">$rootfs</span> /usr/sbin/update-rc.d -f checkroot-bootclean.sh remove
sudo chroot <span class="nv">$rootfs</span> /usr/sbin/update-rc.d -f mountall-bootclean.sh remove
sudo chroot <span class="nv">$rootfs</span> /usr/sbin/update-rc.d -f mountnfs-bootclean.sh remove</code></pre></div>

<h2 id="configure-the-vagrant-user">Configure the vagrant user</h2>

<p>The Ubuntu template <a href="https://github.com/lxc/lxc/blob/staging/templates/lxc-ubuntu.in#L79-L80" target="_blank">creates</a>
an <code>ubuntu</code> user by default and we&rsquo;ll just rename it to <code>vagrant</code> in order to
avoid the need to specify <a href="http://docs.vagrantup.com/v2/vagrantfile/ssh_settings.html" target="_blank">Vagrant&rsquo;s</a>
<code>config.default.username</code> on our Vagrantfiles:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">ROOTFS</span><span class="o">=</span>/var/lib/lxc/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-base/rootfs
sudo chroot <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span> usermod -l vagrant -d /home/vagrant ubuntu</code></pre></div>

<p>The Debian template does not create any user so we&rsquo;ll just add it with <code>adduser</code>:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">ROOTFS</span><span class="o">=</span>/var/lib/lxc/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-base/rootfs
sudo chroot <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span> useradd --create-home -s /bin/bash vagrant</code></pre></div>

<p>At this point it is a good idea to set <code>vagrant</code> as the password too since most
boxes I&rsquo;ve used had this set up like that. The following applies to both Debian
and Ubuntu guests:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> -n <span class="s1">&#39;vagrant:vagrant&#39;</span> <span class="p">|</span> sudo chroot <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span> chpasswd</code></pre></div>

<h3 id="set-up-ssh-access-and-passwordless-sudo">Set up SSH access and passwordless <code>sudo</code></h3>

<p>The steps above ensures the <code>vagrant</code> user exists, but we still need to set up
SSH access by allowing connections using the <a href="https://github.com/mitchellh/vagrant/blob/master/keys/vagrant.pub" target="_blank">default Vagrant SSH key</a>
and also <a href="http://docs-v1.vagrantup.com/v1/docs/base_boxes.html" target="_blank">enable passwordless <code>sudo</code></a>
for things to work properly.</p>

<p>Before we get to that, make sure that <code>sudo</code> is installed on Debian guests and
that the <code>vagrant</code> user belongs to the <code>sudo</code> group by running:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo chroot <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span> apt-get install sudo -y --force-yes
sudo chroot <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span> adduser vagrant sudo</code></pre></div>

<p>If everything went fine, you should now be able to run the commands
below to set up SSH access and enable passwordless <code>sudo</code>:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Configure SSH access
</span><span class="c1"></span>sudo mkdir -p <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span>/home/vagrant/.ssh
sudo wget https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub -O <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span>/home/vagrant/.ssh/authorized_keys
sudo chroot <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span> chown -R vagrant:vagrant /home/vagrant/.ssh

<span class="c1"># Enable passwordless sudo for users under the &#34;sudo&#34; group
</span><span class="c1"></span>sudo cp <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span>/etc/sudoers<span class="o">{</span>,.orig<span class="o">}</span>
sudo sed -i -e <span class="se">\
</span><span class="se"></span>      <span class="s1">&#39;s/%sudo\s\+ALL=(ALL\(:ALL\)\?)\s\+ALL/%sudo ALL=NOPASSWD:ALL/g&#39;</span> <span class="se">\
</span><span class="se"></span>      <span class="si">${</span><span class="nv">ROOTFS</span><span class="si">}</span>/etc/sudoers</code></pre></div>

<p>This is basically enough for us to <a href="#build_box_package">export the container&rsquo;s rootfs and prepare
the vagrant-lxc box</a> but the container is pretty <s>dumb</s> rough
and we can do some work to make it a better place :)</p>

<h2 id="add-yourstuff-to-the-base-container">Add YourStuff™ to the base container</h2>

<p>After the guest container has been created, bring it up with
<code>sudo lxc-start -n ${RELEASE}-base</code> and log in using <code>vagrant</code> as both the user
and password, once you are logged into the container you can do whatever you
want with it. Below you&rsquo;ll find some things that I found useful when building
the current vagrant-lxc boxes.</p>

<p><em>Please note that all of the code below is meant to be run from inside the container</em></p>

<h3 id="avoid-certificate-warnings-when-installing-packages-on-debian-guests">Avoid certificate warnings when installing packages on Debian guests</h3>

<p>If you try to install some package on the container you&rsquo;ll notice that a warning
shows up saying that the packages cannot be authenticated. In order to make it go
away you&rsquo;ll need to install the <code>ca-certificates</code> package and run a <code>apt-get update</code>:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get install -y --force-yes ca-certificates
sudo apt-get update</code></pre></div>

<h3 id="add-some-basic-packages">Add some basic packages</h3>

<p>Make your container a better place and install some &ldquo;must-have&rdquo; packages:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">PACKAGES</span><span class="o">=(</span>vim curl wget manpages bash-completion<span class="o">)</span>
sudo apt-get install <span class="si">${</span><span class="nv">PACKAGES</span><span class="p">[*]</span><span class="si">}</span> -y --force-yes</code></pre></div>

<h3 id="install-chef">Install Chef</h3>

<p>If you want to have <a href="http://www.opscode.com/chef/" target="_blank">Chef</a> pre installed on the
base box, you can run:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl -L https://www.opscode.com/chef/install.sh -k <span class="p">|</span> sudo bash</code></pre></div>

<h3 id="install-puppet">Install Puppet</h3>

<p>If you want to have <a href="https://puppetlabs.com/" target="_blank">Puppet</a> pre installed on the base
box, you can run:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget http://apt.puppetlabs.com/puppetlabs-release-stable.deb -O <span class="s2">&#34;/tmp/puppetlabs-release-stable.deb&#34;</span>
dpkg -i <span class="s2">&#34;/tmp/puppetlabs-release-stable.deb&#34;</span>
sudo apt-get update
sudo apt-get install puppet -y --force-yes</code></pre></div>

<h3 id="free-up-some-disk-space">Free up some disk space</h3>

<p>When you are done configuring the container, make sure you run the code below from
within the container to reduce the rootfs / box size:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo rm -rf /tmp/*
sudo apt-get clean</code></pre></div>

<h2 id="build-box-package">Build box package</h2>

<p>After configuring the container, shut it down by running <code>sudo halt</code> and follow
the steps below from the host to build the <code>.box</code> file:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Set up a working dir
</span><span class="c1"></span>mkdir -p /tmp/vagrant-lxc-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>

<span class="c1"># Compress container&#39;s rootfs
</span><span class="c1"></span><span class="nb">cd</span> /var/lib/lxc/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-base
sudo tar --numeric-owner -czf /tmp/vagrant-lxc-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/rootfs.tar.gz ./rootfs/*

<span class="c1"># Prepare package contents
</span><span class="c1"></span><span class="nb">cd</span> /tmp/vagrant-lxc-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>
sudo chown <span class="nv">$USER</span>:<span class="sb">`</span>id -gn<span class="sb">`</span> rootfs.tar.gz
wget https://raw.github.com/fgrehm/vagrant-lxc/master/boxes/common/lxc-template
wget https://raw.github.com/fgrehm/vagrant-lxc/master/boxes/common/lxc.conf
wget https://raw.github.com/fgrehm/vagrant-lxc/master/boxes/common/metadata.json
chmod +x lxc-template

<span class="c1"># Vagrant box!
</span><span class="c1"></span>tar -czf vagrant-lxc-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>.box ./*</code></pre></div>

<h2 id="try-it-out">Try it out</h2>

<p>To make sure you are able to use the container with vagrant-lxc, try importing
the base box and bring it up with:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">mkdir -p /tmp/test-import <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /tmp/test-import
vagrant init my-box /tmp/vagrant-lxc-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/vagrant-lxc-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>.box
vagrant up --provider<span class="o">=</span>lxc</code></pre></div>

<p>If everything went fine, you should be able to SSH into it with <code>vagrant ssh</code>
without issues.</p>

<p>When you are done with the base container, make sure you destroy it using
<code>sudo lxc-destroy -n ${RELEASE}-base</code> to free up some disc space.</p>

<h2 id="coming-up">Coming up</h2>

<p>Over the following weeks I&rsquo;ll be going through the process of using this approach
to build the &ldquo;official&rdquo; Ubuntu base boxes instead of some hand made <a href="https://github.com/fgrehm/vagrant-lxc/blob/master/tasks" target="_blank">Rake task</a>
and <a href="https://github.com/fgrehm/vagrant-lxc/tree/master/boxes" target="_blank">bash scripts</a>. One of
the good things about following this approach is that because the built-in Ubuntu
template keeps a <a href="https://github.com/lxc/lxc/blob/staging/templates/lxc-ubuntu.in#L340-L345" target="_blank">rootfs cache</a>
around, which means that the base container creation time gets a lot lower and
I&rsquo;m able to iterate over new base boxes a lot faster. After this is proven to work,
I&rsquo;ll try to get my head around <a href="http://golang.org/" target="_blank">Go</a> and will look into adding
support for building lxc root file systems for <a href="http://www.packer.io/" target="_blank">Packer</a>.</p>

<p>That&rsquo;s it! I hope this opens up for others to fill in <a href="https://github.com/fgrehm/vagrant-lxc/wiki/Base-boxes" target="_blank">the Wiki</a>
with instructions for building other distros and <a href="http://www.vagrantbox.es/" target="_blank">http://www.vagrantbox.es/</a>
with pre built boxes :)</p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'fgrehm';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/fgrehm">Fabio Rehm</a> 2017</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-37437857-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>
