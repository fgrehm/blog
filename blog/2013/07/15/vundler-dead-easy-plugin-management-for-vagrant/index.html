<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Vundler: Dead easy plugin management for Vagrant | Fabio Rehm&#39;s Blog</title>

<meta property='og:title' content='Vundler: Dead easy plugin management for Vagrant - Fabio Rehm&#39;s Blog'>
<meta property='og:description' content='Avoid Vagrant plugins Dependency Hell with Vundler'>
<meta property='og:url' content='http://fabiorehm.com/blog/2013/07/15/vundler-dead-easy-plugin-management-for-vagrant/'>
<meta property='og:site_name' content='Fabio Rehm&#39;s Blog'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/104b2f2e55cae5294ac961ce1547b13e?s=256'><meta property='article:section' content='Blog'><meta property='article:tag' content='vagrant'><meta property='article:tag' content='bundler'><meta property='article:tag' content='vundler'><meta property='article:tag' content='vagrant plugins'><meta property='article:published_time' content='2013-07-15T00:00:00Z'/><meta property='article:modified_time' content='2013-07-15T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@fgrehm'><meta name='twitter:creator' content='@fgrehm'>
<link rel="stylesheet" href="http://fabiorehm.com/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://fabiorehm.com"><h1 class="title is-4">Fabio Rehm&#39;s Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:fgrehm%20at%20gmail%20dot%20com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/fabiorehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/vagrant">#vagrant</a>



  
  | <a class="subtitle is-6" href="/tags/bundler">#bundler</a>
  
  | <a class="subtitle is-6" href="/tags/vundler">#vundler</a>
  
  | <a class="subtitle is-6" href="/tags/vagrant-plugins">#vagrant plugins</a>
  

      
    </div>
    <h2 class="subtitle is-6">July 15, 2013</h2>
    <h1 class="title">Vundler: Dead easy plugin management for Vagrant</h1>
      
    <div class="content">
      

<p><strong>UPDATE</strong> (23 JUL 2013): Vundler has been <a href="/blog/2013/07/23/vundler-is-now-bindler">renamed</a>
to Bindler!</p>

<p>Vagrant&rsquo;s plugin &ldquo;ecossystem&rdquo; just keep growing and recently there has been a
lot of interest on having an easy way for managing project&rsquo;s specific plugin
dependencies to avoid <a href="http://en.wikipedia.org/wiki/Dependency_hell" target="_blank">Dependency Hell</a>
and / or to reduce the amount of steps someone has to take when joining an
ongoing project. There are at least 4 issues on Vagrant&rsquo;s issue tracker (<a href="https://github.com/mitchellh/vagrant/issues/1874" target="_blank">#1874</a>,
<a href="https://github.com/mitchellh/vagrant/issues/1789" target="_blank">#1789</a>, <a href="https://github.com/mitchellh/vagrant/issues/1700" target="_blank">#1700</a>
and <a href="https://github.com/mitchellh/vagrant/issues/1574" target="_blank">#1574</a>)
and one <a href="https://github.com/tknerr/vagrant-plugin-bundler" target="_blank">initiative</a>
by <a href="https://github.com/tknerr" target="_blank">@tknerr</a> to solve the problem.</p>

<p>As I said on <a href="https://github.com/mitchellh/vagrant/issues/1874#issuecomment-20137913" target="_blank">this comment</a>
and later clarified on this <a href="https://github.com/mitchellh/vagrant/issues/1874#issuecomment-20146703" target="_blank">other one</a>:</p>

<blockquote>
<p>TBH I don&rsquo;t think this belongs on vagrant core itself. An analogy would be
having this logic from inside Ruby on Rails instead of relying on Bundler,
which IMHO does not make sense. Rails just provides the foundation for others
to build plugins and relies on Bundler to get things in place and load plugins&rsquo; code.</p>

<p>I really believe we need some sort of Bundler for Vagrant as there are
plugins being created almost every month. I just don&rsquo;t think it belongs on
Vagrant&rsquo;s core.</p>
</blockquote>

<p>So I knew that it was something doable but I also knew that it would require some
good knowledge of RubyGems and Vagrant&rsquo;s internals. I&rsquo;ve been brewing the idea on
my head for a while and I had a vague idea of how it could be implemented. Last
week I had some free time and decided to timebox my take on the problem. The result
of 2 hours worth of work is a new plugin called <a href="https://github.com/fgrehm/vundler" target="_blank">Vundler</a>,
a <em>&ldquo;soon-to-be <a href="http://bundler.io/v1.3/rationale.html" target="_blank">Bundler</a> for Vagrant&rdquo;</em>.</p>

<p>It basically adds a new <code>vagrant plugin bundle</code> command that reads from a project
specific <code>plugins.json</code> <a href="https://github.com/fgrehm/vundler#usage" target="_blank">file</a> and <em><a href="https://github.com/fgrehm/vundler/blob/master/lib/vundler/bend_vagrant.rb" target="_blank">bends</a></em>
Vagrant to do its job with a handful of monkey patches.</p>

<p>Have a look at the asciicast to see it in action:</p>

<div class="asciicast-container">
  <script type="text/javascript" src="https://asciinema.org/a/4193.js" id="asciicast-4193" async></script>
</div>

<h2 id="how-does-it-work">How does it work?</h2>

<p>First we need to ensure Vundler is the one and only third party plugin that Vagrant
will load automatically and then do our magic. If other plugins are loaded before
Vundler, there is a huge chance that conflicts will happen as you might have
a globally installed version of a plugin that is different from the version a
project needs.</p>

<p>The simplest thing that could possibly work (and that I can think of right now)
is to trick Vagrant&rsquo;s plugin loading mechanism to only load Vundler and to benefit
from Vagrant&rsquo;s configuration loading order. That is accomplished by making sure
our <code>$HOME/.vagrant.d/plugins.json</code> have only Vundler listed as a plugin and
by having an explicit <code>require &quot;vundler&quot;</code> on our <code>$HOME/.vagrant.d/Vagrantfile</code>.
Because of the way vagrant works, that <code>Vagrantfile</code> will be loaded prior to
any project defined one and we&rsquo;d be good to go.</p>

<p>This initial setup is handled by <code>vagrant vundler setup</code> that should be invoked right
after the plugin gets installed. The command will move the other plugins defined
on the system wide <code>plugins.json</code> file to <code>$HOME/.vagrant.d/global-plugins.json</code>
and will add the explicit <code>require</code> to the system wide <code>Vagrantfile</code>.</p>

<p>Once things are properly set up, you should be able to add a <code>plugins.json</code> file
like the one below to your project and just run <code>vagrant plugin bundle</code> to install
the required dependencies:</p>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">[</span>
  <span class="s2">&#34;vagrant-lxc&#34;</span><span class="p">,</span>
  <span class="p">{</span><span class="nt">&#34;vagrant-cachier&#34;</span><span class="p">:</span> <span class="s2">&#34;0.2.0&#34;</span><span class="p">}</span>
<span class="p">]</span></code></pre></div>

<p>And that&rsquo;s it! Vundler will even be little bit smart and will only install the plugins
that you haven&rsquo;t installed yet ;)</p>

<h2 id="declaring-plugins-on-a-json-file-outside-of-a-vagranfile">Declaring plugins on a JSON file outside of a Vagranfile</h2>

<p>I wanted to make things transparent to those that don&rsquo;t have an urge to use Vundler
(like myself) and also to avoid having to write a parser for this &ldquo;Vundlerfile&rdquo;. Also
because JSON is bundled with Ruby 1.9.3+ (shipped with Vagrant) and this approach is
more aligned with Vagrant&rsquo;s core that uses a JSON file to keep track of installed plugins.
If by any remote chance this kind of stuff gets into Vagrant&rsquo;s core, this is how I
believe it will look like.</p>

<p>This is actually one of the reasons why I decided to start from scratch and chose not
to fork @tknerr&rsquo;s awesome <a href="https://github.com/tknerr/vagrant-plugin-bundler" target="_blank">vagrant-plugin-bundler</a>
or follow other users&rsquo; syntax proposed on Vagrant&rsquo;s issue tracker.</p>

<h2 id="project-specific-gems-plugins-sandbox">Project specific gems / plugins sandbox</h2>

<p>With the plugins manifest format defined, I was able to <a href="https://github.com/fgrehm/vundler/blob/master/lib/vundler/plugin_command/bundle.rb" target="_blank">find my way</a>
to install project specific plugins without issues but a problem showed up because
of system wide plugins installation.</p>

<p>On its current state Vagrant <a href="https://github.com/mitchellh/vagrant/blob/master/plugins/commands/plugin/action/prune_gems.rb" target="_blank">prunes</a>
gems <a href="https://github.com/mitchellh/vagrant/blob/master/plugins/commands/plugin/action.rb#L12-L13" target="_blank">after a plugin</a>
have been installed / uninstalled and that would mean that users would be required
to install dependencies again when switching projects. I&rsquo;m pretty sure Mitchell
have a good reason to do that prunning so I decided to not to change this behavior.</p>

<p>When you run a <code>vagrant plugin bundle</code>, Vundler will configure RubyGems to install
missing plugins to a local <code>.vagrant/gems</code> folder. When you run other vagrant commands,
Vundler will ensure that the local plugins sandbox takes precedence over the system
wide gems home and you&rsquo;ll be able to use system wide plugins along with project specific
ones.</p>

<h2 id="what-s-with-all-that-monkey-patching-https-github-com-fgrehm-vundler-blob-master-lib-vundler-bend-vagrant-rb">What&rsquo;s with all that <a href="https://github.com/fgrehm/vundler/blob/master/lib/vundler/bend_vagrant.rb" target="_blank">monkey patching</a>?</h2>

<p>Well, you know&hellip; I timeboxed the development to 2 hours only, that means I had to take
some shortcuts ;) I did my best to document the patches I had to make and I&rsquo;m willing
to look into a way of better accomodating this kind of plugin from within Vagrant&rsquo;s
core.</p>

<h2 id="it-s-just-a-start">It&rsquo;s just a start</h2>

<p>Vundler is not as powerful as his older brother <a href="http://bundler.io" target="_blank">Bundler</a> and there
are a few things that are currently not supported:</p>

<ul>
<li>There is no way to <a href="http://bundler.io/v1.3/man/gemfile.5.html#SOURCES-source-" target="_blank">specify a custom RubyGems source</a></li>
<li>There is no such thing as a <a href="http://stackoverflow.com/a/7518215" target="_blank">lock file</a></li>
<li>It is not possible to use <a href="http://bundler.io/v1.3/man/gemfile.5.html#GIT-git-" target="_blank">plugins from GitHub</a></li>
<li>It does not attempt to solve conflicts. As an example, if two plugins have different
gem dependency requirements, Vundler won&rsquo;t be able to solve conflicts and things might
start acting weird.</li>
</ul>

<p>I&rsquo;m pretty sure we can leverage Bundler itself to have those features in place and I&rsquo;ll
have a look at Bundler&rsquo;s codebase once I have the need for those &ldquo;advanced&rdquo; features.
To be really honest I personally haven&rsquo;t had the need for a tool like Vundler (yet) as
I&rsquo;m currently the only Vagrant user on my project at work and my &ldquo;plugin stack&rdquo; is
basically:</p>

<ul>
<li><a href="https://github.com/fgrehm/vagrant-cachier" target="_blank">vagrant-cachier</a></li>
<li><a href="https://github.com/fgrehm/vagrant-lxc" target="_blank">vagrant-lxc</a></li>
<li><a href="https://github.com/fgrehm/vagrant-notify" target="_blank">vagrant-notify</a></li>
<li><a href="https://github.com/fgrehm/vagrant-pristine" target="_blank">vagrant-pristine</a></li>
<li><a href="https://github.com/dergachev/vagrant-vbox-snapshot" target="_blank">vagrant-vbox-snapshot</a></li>
</ul>

<p>
  If you look into the <code>.gemspec</code> of each plugin you'll notice that none of them have a
  dependency other than Vagrant itself, so I haven't been bitten by Dependency Hell (yet).
  <s>But I'm willing to push the plugin development further as I do see myself using it
  on the future.</s>
<p>

<p>
  <s>
    I'll be more than happy to look into pull requests and discuss future directions for the
    plugin. I'm also planning to use the <a href="http://felixge.de/2013/03/11/the-pull-request-hack.html">Pull Request Hack</a>
    as I did with <a href="https://github.com/fgrehm/vagrant-cachier/issues/10">vagrant-cachier</a>
    since I'm not gonna be able to do this alone ;)
  </s>
</p>

<p>
  <b>UPDATE</b> (26 AUG 2014): Since Vagrant 1.5 came out with a <a href="https://github.com/mitchellh/vagrant/pull/2769">tight integration</a>
  with Bundler, Bindler is no longer being maintained as it would basically
  require a rewrite of the plugin. The functionality provided by the plugin is
  not yet provided by Vagrant itself but it is likely to be on some future release.
</p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'fgrehm';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/ribice">Fabio Rehm</a> 2017</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-37437857-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>
