<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>vagrant-lxc 0.5.0 and beyond | Fabio Rehm&#39;s Blog</title>

<meta property='og:title' content='vagrant-lxc 0.5.0 and beyond - Fabio Rehm&#39;s Blog'>
<meta property='og:description' content='Find out more about the new version of the plugin and the upcoming work I have planned for it'>
<meta property='og:url' content='http://fabiorehm.com/blog/2013/08/07/vagrant-lxc-0-5-0-and-beyond/'>
<meta property='og:site_name' content='Fabio Rehm&#39;s Blog'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/a198addd98dd9f149c7964a1340c9772?s=256'><meta property='article:section' content='Blog'><meta property='article:tag' content='vagrant-lxc'><meta property='article:tag' content='vagrant'><meta property='article:published_time' content='2013-08-07T00:00:00Z'/><meta property='article:modified_time' content='2013-08-07T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@fgrehm'><meta name='twitter:creator' content='@fgrehm'>
<link rel="stylesheet" href="http://fabiorehm.com/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://fabiorehm.com"><h1 class="title is-4">Fabio Rehm&#39;s Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:fgrehm@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/fabiorehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/vagrant-lxc">#vagrant-lxc</a>



  
  | <a class="subtitle is-6" href="/tags/vagrant">#vagrant</a>
  

      
    </div>
    <h2 class="subtitle is-6">August 7, 2013</h2>
    <h1 class="title">vagrant-lxc 0.5.0 and beyond</h1>
      
    <div class="content">
      

<p>Last week I was able to release vagrant-lxc 0.5.0 and on this post you&rsquo;ll get to
know about some cool new stuff and the upcoming work I have in mind to reach what
I believe would be a nice 1.0.0 milestone.</p>

<h2 id="0-5-0-goodies">0.5.0 goodies</h2>

<p>This release it mostly related to the &ldquo;user experience&rdquo; of using the plugin. Apart
from some highlights you&rsquo;ll get to know below, there are a few small things that
makes people&rsquo;s lives a bit easier:</p>

<ul>
<li>Forwarded ports collision detection - the plugin no longer keeps silent about
forwarding ports that are already in use by the host.</li>
<li>The plugin now errors if required dependencies are not installed - no more
silent errors or stacktraces if the <code>lxc</code> and / or <code>redir</code> packages are not installed.</li>
<li>Support for <code>redir</code> <a href="https://github.com/fgrehm/vagrant-lxc/wiki/Troubleshooting" target="_blank">logging</a>
to syslog - <a href="https://github.com/fgrehm/vagrant-lxc/issues/51#issuecomment-19782247" target="_blank">some people</a>
got bitten by <code>redir</code> issues this so I thought it would be nice to have this
in places</li>
</ul>

<h3 id="support-for-a-sudo-wrapper-script-aka-no-more-sudo-passwords">Support for a <code>sudo</code> wrapper script, aka no more <code>sudo</code> passwords!</h3>

<p>If you are using the plugin from within a VM on a Windows / Mac host you probably
haven&rsquo;t suffered from the pain of typing in your password quite a few times during the day while using
the plugin. While there are certainly smarter ways to work around that, I ended
up adding support for a wrapper / proxy script that allow us to add a single <a href="http://askubuntu.com/a/159009" target="_blank">passwordless sudo</a>
entry on our <code>/etc/sudoers</code> for the plugin to use when <code>sudo</code> is required.</p>

<p>As stated on the <a href="https://github.com/fgrehm/vagrant-lxc#avoiding-sudo-passwords" target="_blank">the README</a>,
right now the script I&rsquo;m using is <strong>really dumb AND INSECURE</strong> but it does the
trick. It&rsquo;s basically a ruby script that acts as a proxy for executing the commands:</p>

<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="ch">#!/usr/bin/env ruby</span>
<span class="nb">exec</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></code></pre></div>

<p>With that in place we can then add a single entry to our <code>/usr/bin/lxc-vagrant-wrapper</code>
like the one below:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">USERNAME <span class="nv">ALL</span><span class="o">=</span>NOPASSWD:/usr/bin/lxc-vagrant-wrapper</code></pre></div>

<p>And tell vagrant-lxc to use it on our <code>Vagrantfile</code>s:</p>

<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># Protip: Drop this into your ~/.vagrant.d/Vagrantfile to apply the configuration to all vagrant-lxc VMs</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&#34;2&#34;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:lxc</span> <span class="k">do</span> <span class="o">|</span><span class="n">lxc</span><span class="o">|</span>
    <span class="n">lxc</span><span class="o">.</span><span class="n">sudo_wrapper</span> <span class="o">=</span> <span class="s1">&#39;/usr/bin/lxc-vagrant-wrapper&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>That&rsquo;s it, no more typing in your password when using vagrant-lxc boxes :)</p>

<p>Since <a href="https://wiki.ubuntu.com/UserNamespace" target="_blank">user namespaces</a> will be
supported at some point, I&rsquo;m not willing to give much attention on improving
this for now and this is the reason I&rsquo;m not bundling this with the plugin. Feel
free to submit a Pull Request in case you have a better idea of doing this,
I&rsquo;ll be more than happy to review it ;)</p>

<h3 id="promiscuous-port-forwarding">&ldquo;Promiscuous&rdquo; port forwarding</h3>

<p>On my <a href="/blog/2013/04/28/lxc-provider-for-vagrant#usage_on_os_x__windows">very first vagrant-lxc post</a>
I showed an example of a <code>Vagrantfile</code> that could be used for setting up a VirtualBox
VM between Mac / Windows hosts and vagrant-lxc containers but because vagrant-lxc &lt; 0.5.0
used to bind forwarded ports with <code>redir</code> only to <code>127.0.0.1</code> there was no easy way of
hitting the guest container directy from the host machine. Starting with 0.5.0 that set
up now works out of the box because the port forwarding will work for any of the
configured VBox IP.</p>

<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&#34;2&#34;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&#34;quantal64&#34;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:vbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb_config</span><span class="o">|</span>
    <span class="c1"># Exposes access to the container</span>
    <span class="n">vb_config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">8000</span><span class="o"></span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
    <span class="o"></span><span class="n">vb_config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">2221</span><span class="o"></span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">2000</span>
  <span class="o"></span><span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:lxc</span> <span class="k">do</span> <span class="o">|</span><span class="n">lxc_config</span><span class="o">|</span>
    <span class="c1"># Exposes a web server and SSH access</span>
    <span class="n">lxc_config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="o"></span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8000</span>
    <span class="o"></span><span class="n">lxc_config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">22</span><span class="o"></span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">2221</span>
  <span class="o"></span><span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>So using a Vagrantfile similiar to the one above you should be able to SSH into
the <code>vbox</code> VM, bring up the <code>lxc</code> container and hit a web server running on the
container on port <code>80</code> through <code>http://localhost:8080</code> from your host or SSH
directly into the guest container from your host with <code>ssh vagrant@localhost -p 2000</code>.</p>

<h3 id="improved-customizations">Improved customizations</h3>

<p>Prior to 0.5.0 the provided <a href="https://github.com/fgrehm/vagrant-lxc#advanced-configuration" target="_blank">customizations</a>
and shared folders bind mounts where passed in as <code>-s</code> parameters to <code>lxc-start</code>.
While that was working fine, it was a PITA to debug which of the configurations
were giving us a bad time because it made us look into Vagrant debug logs to find
out exactly which arguments were being passed in.</p>

<p>Starting with 0.5.0 those customizations are writen out to the container configuration
file (usualy kept under <code>/var/lib/lxc/&lt;container&gt;/config</code>) prior to bringing
it up with <code>lxc-start</code>.</p>

<p>A side effect of that is that in case the container is not able to boot, you can
start the container on the foreground with something like <code>lxc-start -n $(cat .vagrant/machines/&lt;machine-name&gt;/lxc/id)</code>
and replicate vagrant-lxc&rsquo;s behavior. With that you&rsquo;ll be able to find out more
information on why things are not working and you&rsquo;ll be able to tweak the Vagrantfile
/ lxc config file in order to track the issue down.</p>

<p>You can also benefit from this if you want to enable <a href="https://help.ubuntu.com/lts/serverguide/lxc.html#lxc-upstart" target="_blank">LXC Upstart Jobs</a>
for your vagrant-lxc containers on a real server. Although the VM won&rsquo;t be provisioned
automatically and ports won&rsquo;t be forwarded like it normally would when using <code>vagrant up</code>,
shared folders should work just fine and you can easily set up some shared socket
for communication between the host and the guest container to avoid the need of using
forwarded ports.</p>

<h3 id="demo">Demo</h3>

<p>To better understand the new port forwarding, upstart and debugging capabilities
check out the Asciicasts below. To save you some wait time, I&rsquo;ll use the setup
described on <a href="https://gist.github.com/fgrehm/8084ac5442e9cb2b93fc" target="_blank">this gist</a>
with the <a href="https://gist.github.com/fgrehm/8084ac5442e9cb2b93fc#file-02-vagrantfile-rb-L5-L19" target="_blank">VBox VM</a>
already running and the inner <a href="https://gist.github.com/fgrehm/8084ac5442e9cb2b93fc#file-02-vagrantfile-rb-L21-L36" target="_blank">vagrant-lxc container</a>
created. The VBox VM has <a href="http://wiki.nginx.org/Main" target="_blank">Nginx</a>
installed and is <a href="https://gist.github.com/fgrehm/8084ac5442e9cb2b93fc#file-03-provision-vbox-sh-L11-L29" target="_blank">configured</a>
to use proxy <code>/unicorn</code> requests to a Ruby <a href="http://rack.github.io/" target="_blank">Rack</a>
&ldquo;Hello world&rdquo; <a href="https://gist.github.com/fgrehm/8084ac5442e9cb2b93fc#file-04-provision-lxc-sh-L33-L37" target="_blank">application</a>
running behind an <a href="https://github.com/defunkt/unicorn" target="_blank">Unicorn</a> Server
listening on an UNIX socket <a href="https://gist.github.com/fgrehm/8084ac5442e9cb2b93fc#file-02-vagrantfile-rb-L29" target="_blank">shared</a>
between the VBox VM and vagrant-lxc container.</p>

<p>I&rsquo;ve had some trouble recording the Asciicast in one go, so I had to split it
into 2 recordings:</p>

<div class="asciicast-container">
  <script type="text/javascript" src="http://asciinema.org/a/4580.js" id="asciicast-4580" async></script>
  <p>
    Part I - Debugging and port forwarding
  </p>
</div>

<div class="asciicast-container">
  <script type="text/javascript" src="http://asciinema.org/a/4581.js" id="asciicast-4581" async></script>
  <p>
    Part II - vagrant-lxc container upstart and shared folders
  </p>
</div>

<h2 id="how-does-vagrant-lxc-1-0-look-like">How does vagrant-lxc 1.0 look like?</h2>

<p>I&rsquo;ve been asking myself that question for a while now and I think I have a good
list of things to accomplish to reach 1.0. I believe the plugin is pretty stable
at this point (at least for myself) and most of the pain points from the initial
releases have been sorted out (like <code>sudo</code>ing and forwarded ports collision detection)
so I <em>might</em> slow down a bit and focus on other projects for a while.</p>

<p>Of course the list is subject to change but here&rsquo;s what I have in mind:</p>

<ul>
  <li>
    First class networking support, allowing configuration for both
    <a href="https://github.com/fgrehm/vagrant-lxc/issues/119">public</a> and
    <a href="https://github.com/fgrehm/vagrant-lxc/issues/120">private</a> networks.
  </li>
  <li>
    Extract port forwarding with <code>redir</code> out to a
    <a href="https://github.com/fgrehm/vagrant-lxc/issues/101">separate plugin</a>.
  </li>
  <li>
    Write <a href="https://github.com/fgrehm/vagrant-lxc/issues?direction=desc&amp;labels=documentation&amp;page=1&amp;sort=updated">documentation</a>
    for using the plugin on at least 2 distros other than Ubuntu and Debian (and
    probably do some <a href="https://github.com/fgrehm/vagrant-lxc/issues/117#issuecomment-21866996">internal changes</a>
    along the way to make things smoother).
  </li>
  <li>
    Find ways of <a href="https://github.com/fgrehm/vagrant-lxc/issues/99">leveraging lxc-clone / BTRFS</a>.
  </li>
  <li>
    Add support for <a href="https://github.com/fgrehm/vagrant-lxc/issues/32">VirtualBox-like snapshots</a>
    and <a href="https://github.com/fgrehm/vagrant-lxc/issues/33">ephemeral containers</a>.
  </li>
</ul>

<p>If you can think of something else or have any suggestion feel free to reach out ;)</p>

<p><em><strong>UPDATE</strong>: Please check out <a href="/blog/2013/12/12/so-i-released-a-lot-of-vagrant-plugins-now-what-s-next">this other post</a>
to find out more about my latest plans regarding 1.0</em></p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'fgrehm';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/ribice">Fabio Rehm</a> 2017</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-37437857-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>
