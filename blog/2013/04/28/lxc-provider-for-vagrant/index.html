<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>LXC provider for Vagrant | Fabio Rehm&#39;s Blog</title>

<meta property='og:title' content='LXC provider for Vagrant - Fabio Rehm&#39;s Blog'>
<meta property='og:description' content='Run your Vagrant boxes as Linux Containers'>
<meta property='og:url' content='http://fabiorehm.com/blog/2013/04/28/lxc-provider-for-vagrant/'>
<meta property='og:site_name' content='Fabio Rehm&#39;s Blog'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/a198addd98dd9f149c7964a1340c9772?s=256'><meta property='article:section' content='Blog'><meta property='article:tag' content='vagrant'><meta property='article:tag' content='lxc'><meta property='article:tag' content='linux containers'><meta property='article:tag' content='video'><meta property='article:published_time' content='2013-04-28T00:00:00Z'/><meta property='article:modified_time' content='2013-04-28T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@fgrehm'><meta name='twitter:creator' content='@fgrehm'>
<link rel="stylesheet" href="http://fabiorehm.com/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://fabiorehm.com"><h1 class="title is-4">Fabio Rehm&#39;s Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:fgrehm@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/fabiorehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/fgrehm' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/vagrant">#vagrant</a>



  
  | <a class="subtitle is-6" href="/tags/lxc">#lxc</a>
  
  | <a class="subtitle is-6" href="/tags/linux-containers">#linux containers</a>
  
  | <a class="subtitle is-6" href="/tags/video">#video</a>
  

      
    </div>
    <h2 class="subtitle is-6">April 28, 2013</h2>
    <h1 class="title">LXC provider for Vagrant</h1>
      
    <div class="content">
      

<p><em><strong>UPDATE</strong>: This post is likely to be out of date, please see <a href="/blog/2015/07/21/quick-update-about-some-vagrant-plugins">this post</a>
for more</em></p>

<p>It&rsquo;s been nearly 2 months since I open sourced my &ldquo;not so pretty&rdquo; <a href="https://github.com/fgrehm/vagrant-lxc/tree/55c9be772db32d4f49bf61af1801d2d6f14a880e" target="_blank">initial spike</a>
and <a href="https://groups.google.com/d/topic/vagrant-up/fp3UfclJDg8/discussion" target="_blank">announced</a> on
Vagrant&rsquo;s mailing list that I was going to work on this. By that time, Vagrant 1.1 wasn&rsquo;t
even released yet and it was a <a href="https://github.com/fgrehm/vagrant-lxc/contributors" target="_blank">long</a>
<a href="http://rubygems.org/gems/vagrant-lxc/versions" target="_blank">way</a> to get where it is now.</p>

<p>Almost two weeks after &ldquo;releasing&rdquo; the spike, Vagrant 1.1 <a href="http://www.hashicorp.com/blog/vagrant-1-1-and-vmware.html" target="_blank">came out</a>
and by then someone <a href="https://twitter.com/fgrehm/status/312340609350385664" target="_blank">challenged</a>
people to write a LXC <a href="http://docs.vagrantup.com/v2/providers/index.html" target="_blank">provider</a>
for it. I felt great since I was already using <a href="https://github.com/fgrehm/vagrant-lxc" target="_blank">vagrant-lxc</a>
over the past couple weeks :)</p>

<p>For those who have never heard about <a href="http://lxc.sourceforge.net/" target="_blank">LXC</a>
, it is <em>&ldquo;the userspace control package for Linux Containers, a lightweight
virtual system mechanism sometimes described as &lsquo;chroot on steroids&rsquo;&rdquo;</em>.
As a &ldquo;real world&rdquo; example, it is the technology that powers Heroku&rsquo;s <a href="https://devcenter.heroku.com/articles/dynos#technologies" target="_blank">Dynos</a>
and probably a whole lot of <a href="http://blog.dotcloud.com/paas-under-the-hood-ebook" target="_blank">other PaaS providers</a>.</p>

<p>Below you&rsquo;ll be able to watch a video / screencast that demonstrates the plugin
on its current state.</p>

<div class="flash-video">
  <iframe src="http://player.vimeo.com/video/64778133?portrait=0" width="720" height="405" frameborder="0" webkitAllowFullScreen="true" mozallowfullscreen="true" allowFullScreen="true"></iframe>
  <p>
    Please note that the video is "mute" (like HashiCorp's <a href="http://www.hashicorp.com/blog/preview-vagrant-aws.html">AWS</a>
    and <a href="https://vimeo.com/58059557">VMWare Fusion</a> videos), so make sure
    you get yourself some nice soundtrack to watch it :)
  </p>
</div>

<p>Alright, that last bit was cool hey? I&rsquo;m not sure exactly how I&rsquo;ll explore that
yet but it was crazy when I realized that it was possible.</p>

<h2 id="a-few-notes-about-the-video">A few notes about the video</h2>

<ul>
<li>I&rsquo;m not sure you noticed but the nginx base box exported shows <code>quantal64</code> as the
hostname on the prompt but it is actually a <code>precise64</code> box. Don&rsquo;t worry,
it is a <a href="https://github.com/fgrehm/vagrant-lxc/issues/60" target="_blank">known issue</a> (that has
been fixed already).</li>
<li>If you have used lxc before you might be asking yourself why haven&rsquo;t I been asked
for root privileges not even once. The reason behind it is that all the time I
was on a vagrant box which by definition requires passwordless <code>sudo</code> to be <a href="http://docs-v1.vagrantup.com/v1/docs/base_boxes.html" target="_blank">enabled</a>.</li>
<li>When compressing boxes <code>tar</code> might throw up some <a href="https://github.com/fgrehm/vagrant-lxc/issues/46" target="_blank">warnings</a>
on you. I don&rsquo;t know exactly what I&rsquo;m going to do about that but I&rsquo;ll look into
it ASAP.</li>
<li>I know that the video quality is not the best in the world, I actually fought a
lot to be able to properly edit it after recording with <a href="http://recordmydesktop.sourceforge.net/about.php" target="_blank">recordMyDesktop</a>
until I <a href="http://superuser.com/a/484288" target="_blank">found a solution</a>. Please LMK if you
know better tools to record high quality screencasts on Ubuntu :)</li>
</ul>

<h2 id="why-bother">Why bother?</h2>

<p>So far I&rsquo;ve been using the plugin pretty much every day to work on some Ruby on
Rails projects with great success. Before that I was a VirtualBox user and so
far LXC has proven not only to perform better but to be more stable (at least
for my work).</p>

<p>My primary goal with this was to have a lightweight alternative for VirtualBox
for Linux users and after <a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food" target="_blank">eating my own dog food</a>
for the last 2 months I believe I was able to achieve that. <a href="https://twitter.com/fgrehm/status/313746305195323392" target="_blank">I do see it being pushed</a>
to its limits and I already know about people going further and using it for
continous integration but I don&rsquo;t see it being my main focus for the short term
(more on this below). From what I&rsquo;ve read it looks like some people have struggled
to use lxc and vagrant-lxc attempts to make it a no brainer.</p>

<p>I&rsquo;m not saying that &ldquo;VirtualBox is dead&rdquo; neither that LXC is perfect. There are
also other proven virtualization technologies take into consideration too (like
<a href="http://libvirt.org/" target="_blank">libvirt</a> or <a href="http://www.linux-kvm.org/page/Main_Page" target="_blank">KVM</a>
for example). For instance, I still use VBox to <a href="https://github.com/fgrehm/vagrant-lxc/wiki/Development#using-virtualbox-for-development" target="_blank">try out new things while developing the provider</a>
and there will be times that you&rsquo;ll need to have a full blown VM (like when you
need to test your web apps on IE :)</p>

<h2 id="performance">Performance</h2>

<p>Although I haven&rsquo;t done any &ldquo;serious&rdquo; benchmarking, performance wise I <em>feel</em>
that things are &ldquo;faster&rdquo;. I&rsquo;ll save the benchmark to another post but one thing
I can say for sure: bringing a vagrant-lxc container up from scratch and reloading
it is a lot faster (no double quotes here).</p>

<p>On my machine, it takes around <code>01:31</code> to bring a clean Ubuntu 12.10 VBox VM up
from scratch and <code>00:40</code> to reload it, with vagrant-lxc those numbers go down to
<code>00:30</code> and <code>00:12</code> respectively, that alone is a HUGE win. If you have done any
Puppet or Chef development using Vagrant for a long time you have probably spent a
fair bit of time recreating / restarting machines to try things out and a lxc
container can potentially save you from a lot of waiting time.</p>

<p>Another cool thing about using containers is that they <a href="http://wiki.gentoo.org/wiki/LXC#Container-based_Virtualization_.28lxc.29" target="_blank">share</a>
your host&rsquo;s Kernel and resources. I&rsquo;m not a 100% sure but I believe that at least
in theory it means you&rsquo;d achieve the same performance as if you were running things
directly on your physical machine. You <em>can</em> limit the amount of memory and CPU
cores / shares the containers will get by configuring <a href="http://en.gentoo-wiki.com/wiki/LXC#Control_Groups" target="_blank">Control Groups</a>
but by default it will allow using everything you&rsquo;ve got.</p>

<p>On a site note, if you need to run <a href="https://github.com/guard/guard" target="_blank">Guard</a> on the
guest machine it will simply work. There&rsquo;s no need to <a href="https://github.com/guard/listen/issues/53" target="_blank">enable pooling</a>
neither you need to <a href="/blog/2013/01/17/100-percent-on-vagrant/#enable_nfs">enable NFS shared folders</a>
to have a reasonable performance.</p>

<h2 id="stability">Stability</h2>

<p>I&rsquo;ve been using VirtualBox even before I got to know Vagrant (which happened just
last year). I began using it back in 2009 when I used to be a frustrated Windows
user trying to learn Ruby on Rails. After consecutive failed attempts to get things
working within Windows and not switching to Linux I had to rely on a VM to work.
I ended up spending a lot of my time inside the VM and one of the main reasons
that made me &ldquo;promote&rdquo; Linux to my main OS was that VBox was crashing and acting
weird quite a lot.</p>

<p>After switching to Linux I started using VirtualBox as my own little &ldquo;playground&rdquo;.
Whenever I wanted to try out some new stuff that could potentially mess up with
my host OS or had lots of dependencies I&rsquo;d do it there. In my experience, the
amount of crashes / issues I had reduced dramatically but were still present.</p>

<p>So far my experience with LXC has been awesome, I haven&rsquo;t experienced any crash
at all during normal usage. The only problem I had so far was a <a href="https://github.com/fgrehm/vagrant-lxc#help-im-unable-to-restart-containers" target="_blank"><em>buggy</em> Kernel</a>
and a hard time trying to boot nested containers as I&rsquo;ve done on the video.</p>

<h2 id="usage-on-os-x-windows">Usage on OS X / Windows</h2>

<p>Even if you have never heard about LXC, by now you might have guessed that it does
not work on OS X nor Windows hosts. But you can still benefit from it!</p>

<p>As I said the time taken to recreate containers is lower than what you&rsquo;ll get with
VirtualBox so you can use it to get a faster feedback about Puppet manifests / Chef
cookbooks even though your physical machine can&rsquo;t create containers. Right now you
are thinking: &ldquo;but dude, I&rsquo;m on a mac / windows! how will I use this?&rdquo;. Well, if
you watched the video you&rsquo;ll probably remember that the &ldquo;box stack&rdquo; I&rsquo;ve shown
has a VBox container between my laptop and the other containers. My laptop has
Ubuntu 12.10 installed but you could easily replace it with a Windows or
OS X machine (and why not use it from a EC2 instance managed by <a href="https://github.com/mitchellh/vagrant-aws" target="_blank">vagrant-aws</a>
;)</p>

<p>With the proper Vagrant setup, you can make it a trivial process. Imagine you
have this Vagrantfile:</p>

<script src="https://gist.github.com/fgrehm/5463831.js"></script>

<p>When you run:</p>

<pre><code>[host] $ vagrant up vbox
[host] $ vagrant ssh vbox

[vbox] $ vagrant plugin install vagrant-lxc
[vbox] $ cd /vagrant
[vbox] $ vagrant box add quantal64 http://dl.dropbox.com/u/13510779/lxc-quantal-amd64-2013-04-21.box
[vbox] $ vagrant up lxc --provider=lxc
</code></pre>

<p>You&rsquo;ll end up with a container ready to rock. Because of the way the ports
are being forwarded, you could potentially be able to hit an Apache instance
running on the container on port <code>80</code> directly by going to <a href="http://localhost:3001" target="_blank">http://localhost:3001</a>
in your browser. You might as well set up the container to automatically start
when the VBox machine goes up to save you some trouble.</p>

<p><s>Before you alt-tab to try it out, please keep in mind that on its current
state it won&rsquo;t work out of the box but I believe that it wouldn&rsquo;t be hard to automate
that process and <a href="https://github.com/fgrehm/vagrant-lxc/issues/23" target="_blank">I do have plans</a>
to make it a no brainer as well.</s>
<em><strong>UPDATE</strong>: As of <a href="/blog/2013/08/02/vagrant-lxc-0-5-0-and-beyond#promiscuous-port-forwarding">vagrant-lxc 0.5.0</a>
that now works!</em></p>

<h2 id="worth-mentioning-limitations">&ldquo;Worth mentioning&rdquo; limitations</h2>

<ul>
<li>Port forwarding is currently being handled by <code>redir</code>. I&rsquo;ve failed several times
to make it work with just <code>iptables</code> since it is bundled with pretty much every
Linux installation and it seems that it is not possible. Ideally we should not
depend on <code>redir</code> but for now it does the trick.</li>
<li>&ldquo;Advanced networking&rdquo; Vagrant features are not implemented yet. <s>If you need
features like <a href="http://docs.vagrantup.com/v2/networking/forwarded_ports.html" target="_blank">automatic port collision handling</a>
you&rsquo;ll need to wait a bit more</s> <em><strong>UPDATE</strong>: as of <a href="https://github.com/fgrehm/vagrant-lxc/blob/master/CHANGELOG.md#050-aug-1-2013" target="_blank">vagrant-lxc 0.5.0</a>
port collisions are now properly sorted out automatically.</em></li>
<li>Until <a href="https://wiki.ubuntu.com/UserNamespace" target="_blank">user namespaces</a> get into the
mainstream kernel there will be a hell lot of <code>sudo</code>s involved. <s>I&rsquo;m looking
into different approaches of working around them and reducing to a minimum,
nothing rock solid yet.</s> <em><strong>UPDATE</strong>: as of 0.5.0 there is support for using
a &ldquo;<a href="/blog/2013/08/07/vagrant-lxc-0-5-0-and-beyond#support-for-a-sudo-wrapper-script-aka-no-more-sudo-passwords">sudo wrapper script</a>&rdquo;.</em></li>
<li>If you need a GUI inside your VMs you are on your own to properly set it up.
Making it work from within vagrant-lxc is <a href="https://github.com/fgrehm/vagrant-lxc/issues/44" target="_blank">also planned</a>
but it is currently a low priority for me.</li>
</ul>

<h2 id="what-about-docker-http-www-docker-io">What about <a href="http://www.docker.io/" target="_blank">Docker</a>?</h2>

<p>I&rsquo;d love to play more with Docker and I actually thought of <a href="https://github.com/fgrehm/vagrant-lxc/issues/41" target="_blank">integrating it with
vagrant-lxc</a>. I keep hearing
people talk a lot about it but I only got to play with it for a couple days. As I
commented on this <a href="https://github.com/dotcloud/docker/issues/404#issuecomment-16697703" target="_blank">GitHub issue</a>,
I actually don&rsquo;t think a Docker provider would be a &ldquo;competitor&rdquo; to the pure lxc
implementation, my goal is to have it as a replacement to VirtualBox for
Linux users. On the other hand: <em>&ldquo;Docker complements LXC with a high-level API
which operates at the process level. It runs unix processes with strong guarantees
of isolation and repeatability across servers&rdquo;</em>.</p>

<p>Given what I know so far, my initial impression is that the Docker provider would
be something like an &ldquo;advanced vagrant-lxc&rdquo;, don&rsquo;t know&hellip; To be honest, I neither
played with Docker enough nor I have a deep knowledge around linux containers
itself to understand if that actually makes sense, but at least is one less
dependency for users to install ;)</p>

<h2 id="ok-so-what-s-next">Ok, so what&rsquo;s next?</h2>

<p>Now that the basic functionallity is in place and things seem to be stable, my
main focus will now shift to write documentation and to improve the current
codebase. I&rsquo;ve started working on this even before there was any official Vagrant
1.1 documentation (remember that I had a somewhat working version even before 1.1
got released?) and the internal design has not changed that much since then. There
is a lot of improvements that can be made to the codebase in order to take the
project to the &ldquo;next level&rdquo;. I also have a lot of homework to do and I want to
dig deeper into LXC itself before pushing more functionality into the plugin.</p>

<p>We definitely need more base boxes to increase adoption, so far I <a href="https://github.com/fgrehm/vagrant-lxc#available-boxes" target="_blank">released 3
versions of Ubuntu</a> and I&rsquo;ve
just received a <a href="https://github.com/fgrehm/vagrant-lxc/pull/65" target="_blank">pull request</a>
with the scripts to build Debian base boxes. I personally only use Ubuntu
boxes so feel free to contribute with scripts to build base boxes for other
distros (documentation about building base boxes are <a href="https://github.com/fgrehm/vagrant-lxc/issues/67" target="_blank">on the way</a>).</p>

<p>As I wrote above, <code>redir</code> is something that I don&rsquo;t want to depend on and I&rsquo;d love
to know better alternatives for it. I also need to think about a way of properly
exposing forwarded guest containers&rsquo; port to the outer world. This is <em>probably</em>
the next functionality that might get into the plugin.</p>

<p>There is also a few <a href="https://github.com/fgrehm/vagrant-lxc/issues?labels=core&amp;page=1&amp;state=open" target="_blank">core features missing</a>,
some extra functionality <a href="https://github.com/fgrehm/vagrant-lxc/issues?labels=enhancement&amp;page=1&amp;state=open" target="_blank">planned</a>
and some known <a href="https://github.com/fgrehm/vagrant-lxc/issues?labels=bug&amp;page=1&amp;state=open" target="_blank">bugs</a>
to be fixed. I&rsquo;m not sure in what order I&rsquo;m going to tackle those guys yet but
feel free to sign up to fix / implement any of them or report bugs as you find
them. Any kind of help will be greatly appreaciated here since I&rsquo;ve been doing
this pretty much all by myself so far.</p>

<h2 id="summing-up">Summing up</h2>

<p>I hope you enjoyed reading this post and watching the video. Feel free to reach
me in case you need any help. I tried to write my current feelings about all this
and after some thought I chose to end this post by just quoting <a href="http://www.hashicorp.com/blog/preview-vagrant-aws.html" target="_blank">HashiCorp</a>
which perfectly maps to my current thinking:</p>

<blockquote>
<p>I’m very excited for the opportunities and use cases this unlocks, as well as the
potential to dramatically improve end-to-end productivity and testability of your
work environments.</p>
</blockquote>

<p><em>A special thanks goes to those that reviewed the initial version of the video and
somehow contributed to this post. I own all of you a beer :D</em></p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'fgrehm';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/fgrehm">Fabio Rehm</a> 2017</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-37437857-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>
